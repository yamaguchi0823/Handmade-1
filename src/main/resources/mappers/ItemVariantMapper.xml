<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.app.mapper.ItemVariantMapper">

    <!-- バリエーション全件取得 -->
    <select id="findAll" 
    	resultType="ItemVariant">
        SELECT
        	id,
            item_id AS itemId,
            color,
            size,
            category,
            quantity_per_set AS quantityPerSet, 
            stock,
            cost_price AS costPrice,
            price,
            sku_code AS skuCode,
            image_filename AS imageFilename,
            is_deleted AS isDeleted,
            created_at AS createdAt,
            updated_at AS updatedAt
        FROM item_variants
        ORDER BY id ASC
    </select>
    
    <!-- 商品IDに紐づくバリエ一覧 -->
	<select id="findByItemId" 
		parameterType="long"
		resultType="ItemVariant">
		SELECT
			id,
            item_id AS itemId,
            color,
            size,
            category,
            quantity_per_set AS quantityPerSet,
            stock,
            cost_price AS costPrice,
            price,
            sku_code AS skuCode,
            image_filename AS imageFilename,
            is_deleted AS isDeleted,
            created_at AS createdAt,
            updated_at AS updatedAt
		FROM item_variants
		WHERE item_id = #{itemId}
			and is_deleted = 0
		ORDER BY id ASC
	</select>
	
	<!-- バリエーション取得 -->
	<select id="findById"
		parameterType="long" 
		resultType="ItemVariant">
		SELECT
			id,
            item_id AS itemId,
            color,
            size,
            category,
            quantity_per_set AS quantityPerSet,
            stock,
            cost_price AS costPrice,
            price,
            sku_code AS skuCode,
            image_filename AS imageFilename,
            is_deleted AS isDeleted,
            created_at AS createdAt,
            updated_at AS updatedAt
		FROM item_variants 
		WHERE id = #{id}
			and is_deleted = 0
	</select>
	
	<!-- 登録 -->
	<insert id="insert" parameterType="ItemVariant">
		INSERT INTO item_variants
			(item_id, color, size, category, quantity_per_set, stock, cost_price, price, sku_code, image_filename, created_at, updated_at)
		VALUES
			(#{itemId},#{color},#{size},#{category},#{quantityPerSet},#{stock},#{costPrice},#{price},#{skuCode},#{imageFilename},NOW(),NOW())
	</insert>
	
	<!-- 更新 -->
	<update id="update" parameterType="ItemVariant">
	    UPDATE item_variants 
	    SET
	        color = #{color},
	        size = #{size},
	        category = #{category},
	        quantity_per_set = #{quantityPerSet},
<!--	        stock = #{stock},-->
	        cost_price = #{costPrice},
	        price = #{price},
	        sku_code = #{skuCode},
	        image_filename = #{imageFilename},
	        updated_at = NOW()
	    WHERE id = #{id}
	</update>
	
	<update id="clearImage">
		UPDATE item_variants 
		SET
			image_filename = NULL,
			updated_at = NOW()
		WHERE id = #{id}
	</update>
	
	<!-- 在庫の直接更新 -->
	<update id="updateStock">
		UPDATE item_variants 
		SET 
			stock = #{stock},
			updated_at = NOW()
		WHERE id = #{id}
	</update>
	
	<!-- 在庫 +qty -->
	<update id="increaseStock">
		UPDATE item_variants 
		SET 
			stock = stock + #{qty},
			updated_at = NOW() 
		WHERE id = #{id}
	</update>
	
	<!-- 在庫 -qty -->
	<update id="decreaseStock">
		UPDATE item_variants 
		SET 
			stock = stock - #{qty},
			updated_at = NOW() 
		WHERE id = #{id}
	</update>
	
	<!-- 削除→ではなく論理削除 -->
	<update id="delete" parameterType="long">
    UPDATE item_variants 
    SET 
        is_deleted = 1,
        updated_at = NOW()
	WHERE id = #{id}
	</update>
	
</mapper>